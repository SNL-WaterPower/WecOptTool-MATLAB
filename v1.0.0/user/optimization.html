

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2. Optimizing an Existing WEC Model &mdash; WecOptTool 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  <link rel="stylesheet" href="../_static/banner.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3. WEC Model Architecture" href="model.html" />
    <link rel="prev" title="1. Setup" href="setup.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> WecOptTool
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup.html">1. Setup</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2. Optimizing an Existing WEC Model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">2.1. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#define-a-sea-state">2.2. Define a sea state</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-file-storage">2.3. Create file storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-an-objective-function">2.4. Create an objective function</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#define-the-inputs">2.4.1. Define the inputs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#define-design-variables">2.4.2. Define design variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#calculate-controlled-device-performance">2.4.3. Calculate controlled device performance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#define-the-objective-function-value">2.4.4. Define the objective function value</a></li>
<li class="toctree-l3"><a class="reference internal" href="#record-intermediate-values">2.4.5. Record intermediate values</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#set-optimization-solver">2.5. Set optimization solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-optimizer-and-view-results">2.6. Run optimizer and view results</a></li>
<li class="toctree-l2"><a class="reference internal" href="#examine-optimum-design">2.7. Examine optimum design</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="model.html">3. WEC Model Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">4. API</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">5. License</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">6. References</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">WecOptTool</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>2. Optimizing an Existing WEC Model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/user/optimization.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  


    
    



    <p class="scv-banner scv-sphinx_rtd_theme"><a href="../../v1.0.1/user/optimization.html"><b>Warning:</b> This document is for an old version of WecOptTool. The latest version is v1.0.1.</a></p>
<div class="section" id="optimizing-an-existing-wec-model">
<span id="optimization"></span><h1>2. Optimizing an Existing WEC Model<a class="headerlink" href="#optimizing-an-existing-wec-model" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>2.1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This section explains and expands upon the <a class="reference external" href="https://github.com/SNL-WaterPower/WecOptTool/blob/master/examples/RM3/optimization.m"><code class="docutils literal notranslate"><span class="pre">optimization.m</span></code></a> example file
provided in the <code class="docutils literal notranslate"><span class="pre">examples/RM3</span></code> directory of the WecOptTool source code. This
example considers the DOE Reference Model 3 (<a class="reference external" href="https://tethys-engineering.pnnl.gov/signature-projects/rm3-wave-point-absorber">RM3</a>) device.</p>
<details><summary><clickme>See the entire example file</clickme></summary></br><div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">%% optimization.m</span>
<span class="c">% Example of an optimization study</span>

<span class="c">%% Define and store sea state of interest</span>

<span class="c">% Create Bretschnider spectrum from WAFO and trim  off frequencies that </span>
<span class="c">% have less that 1% of the max spectral density</span>
<span class="c">% S = bretschneider([],[8,10],0);</span>
<span class="c">% SS = WecOptTool.SeaState(S, &quot;trimFrequencies&quot;, 0.01)</span>

<span class="c">% Load an example with multiple sea-states (8 differing spectra) and trim </span>
<span class="c">% off frequencies that have less that 1% of the max spectral density</span>
<span class="n">SS</span> <span class="p">=</span> <span class="n">WecOptTool</span><span class="p">.</span><span class="n">SeaState</span><span class="p">.</span><span class="n">example8Spectra</span><span class="p">(</span><span class="s">&quot;trimFrequencies&quot;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">);</span>

<span class="c">%% Create a folder for storing intermediate files</span>
<span class="n">folder</span> <span class="p">=</span> <span class="n">WecOptTool</span><span class="p">.</span><span class="n">AutoFolder</span><span class="p">();</span>

<span class="c">%% Optimization Setup</span>

<span class="c">% Add geometry design variables (parametric)</span>
<span class="n">x0</span> <span class="p">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">1.125</span><span class="p">,</span> <span class="mi">42</span><span class="p">];</span>
<span class="n">lb</span> <span class="p">=</span> <span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mi">41</span><span class="p">];</span>
<span class="n">ub</span> <span class="p">=</span> <span class="p">[</span><span class="mf">5.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">,</span> <span class="mi">43</span><span class="p">];</span>

<span class="c">% Define optimisation options</span>
<span class="n">opts</span> <span class="p">=</span> <span class="n">optimoptions</span><span class="p">(</span><span class="s">&#39;fmincon&#39;</span><span class="p">);</span>
<span class="n">opts</span><span class="p">.</span><span class="n">FiniteDifferenceType</span> <span class="p">=</span> <span class="s">&#39;central&#39;</span><span class="p">;</span>
<span class="n">opts</span><span class="p">.</span><span class="n">UseParallel</span> <span class="p">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">opts</span><span class="p">.</span><span class="n">MaxFunctionEvaluations</span> <span class="p">=</span> <span class="mi">5</span><span class="p">;</span> <span class="c">% set artificial low for fast running</span>
<span class="n">opts</span><span class="p">.</span><span class="n">Display</span> <span class="p">=</span> <span class="s">&#39;iter&#39;</span><span class="p">;</span>

<span class="c">% Enable dynamic plotting</span>
<span class="c">% opts.PlotFcn = {@optimplotx,@optimplotfval};</span>

<span class="c">% Define unused parameters</span>
<span class="n">A</span> <span class="p">=</span> <span class="p">[];</span>
<span class="n">B</span> <span class="p">=</span> <span class="p">[];</span>
<span class="n">Aeq</span> <span class="p">=</span> <span class="p">[];</span>
<span class="n">Beq</span> <span class="p">=</span> <span class="p">[];</span>
<span class="n">NONLCON</span> <span class="p">=</span> <span class="p">[];</span>

<span class="c">%% Optimization Execution</span>

<span class="c">% Create simple objective function handle</span>
<span class="n">objFun</span> <span class="p">=</span> <span class="p">@(</span><span class="n">x</span><span class="p">)</span> <span class="n">myWaveBotObjFun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">SS</span><span class="p">,</span> <span class="n">folder</span><span class="p">);</span>

<span class="c">% Call the solver</span>
<span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">fval</span><span class="p">]</span> <span class="p">=</span> <span class="n">fmincon</span><span class="p">(</span><span class="n">objFun</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Aeq</span><span class="p">,</span> <span class="n">Beq</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">NONLCON</span><span class="p">,</span> <span class="n">opts</span><span class="p">);</span>

<span class="c">%% Recover device object of best simulation and plot its power per freq</span>
<span class="c">%% and mesh</span>
<span class="n">performances</span> <span class="p">=</span> <span class="n">folder</span><span class="p">.</span><span class="n">recoverVar</span><span class="p">(</span><span class="s">&quot;performances&quot;</span><span class="p">);</span>
    
<span class="n">for</span> <span class="s">i</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">performances</span><span class="p">)</span>
    <span class="n">test</span> <span class="p">=</span> <span class="n">performances</span><span class="p">{</span><span class="nb">i</span><span class="p">};</span>
    <span class="n">if</span> <span class="s">isequal(test(1).x,</span> <span class="s">x)</span>
        <span class="n">bestPerformances</span> <span class="p">=</span> <span class="n">test</span><span class="p">;</span>
        <span class="n">break</span>
    <span class="s">end</span>
<span class="k">end</span>

<span class="n">WecOptTool</span><span class="p">.</span><span class="n">plot</span><span class="p">.</span><span class="n">powerPerFreq</span><span class="p">(</span><span class="n">bestPerformances</span><span class="p">);</span>
<span class="n">WecOptTool</span><span class="p">.</span><span class="n">plot</span><span class="p">.</span><span class="n">plotMesh</span><span class="p">(</span><span class="n">bestPerformances</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">meshes</span><span class="p">);</span>

<span class="c">%% Define objective function</span>
<span class="c">% This can take any form that complies with the requirements of the MATLAB</span>
<span class="c">% optimization functions</span>

<span class="k">function</span><span class="w"> </span>fval <span class="p">=</span><span class="w"> </span><span class="nf">myWaveBotObjFun</span><span class="p">(</span>x, seastate, folder<span class="p">)</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="n">w</span> <span class="p">=</span> <span class="n">seastate</span><span class="p">.</span><span class="n">getRegularFrequencies</span><span class="p">(</span><span class="mf">0.5</span><span class="p">);</span>
    <span class="n">geomParams</span> <span class="p">=</span> <span class="p">[</span><span class="n">folder</span><span class="p">.</span><span class="n">path</span> <span class="n">num2cell</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">w</span><span class="p">];</span>

    <span class="p">[</span><span class="n">deviceHydro</span><span class="p">,</span> <span class="n">meshes</span><span class="p">]</span> <span class="p">=</span> <span class="n">designDevice</span><span class="p">(</span><span class="s">&#39;parametric&#39;</span><span class="p">,</span> <span class="n">geomParams</span><span class="p">{:});</span>
    
    <span class="n">for</span> <span class="s">j</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">seastate</span><span class="p">)</span>
        <span class="n">performances</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span> <span class="p">=</span> <span class="n">simulateDevice</span><span class="p">(</span><span class="n">deviceHydro</span><span class="p">,</span>   <span class="k">...</span>
                                         <span class="n">seastate</span><span class="p">(</span><span class="nb">j</span><span class="p">),</span>   <span class="k">...</span>
                                         <span class="s">&#39;CC&#39;</span><span class="p">);</span>
    <span class="n">end</span>
    
    <span class="s">fval</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">weightedPower</span><span class="p">(</span><span class="n">seastate</span><span class="p">,</span> <span class="n">performances</span><span class="p">);</span>
    
    <span class="p">[</span><span class="n">performances</span><span class="p">(:).</span><span class="n">w</span><span class="p">]</span> <span class="p">=</span> <span class="n">seastate</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
    <span class="n">performances</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">x</span> <span class="p">=</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">performances</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">meshes</span> <span class="p">=</span> <span class="n">meshes</span><span class="p">;</span>
    
    <span class="n">folder</span><span class="p">.</span><span class="n">stashVar</span><span class="p">(</span><span class="n">performances</span><span class="p">);</span>

<span class="n">end</span>

<span class="s">function</span> <span class="s">out</span> <span class="p">=</span> <span class="n">weightedPower</span><span class="p">(</span><span class="n">seastate</span><span class="p">,</span> <span class="n">performances</span><span class="p">)</span>
    <span class="n">pow</span> <span class="p">=</span> <span class="n">sum</span><span class="p">([</span><span class="n">performances</span><span class="p">.</span><span class="n">powPerFreq</span><span class="p">]);</span>
    <span class="n">out</span> <span class="p">=</span> <span class="nb">dot</span><span class="p">(</span><span class="n">pow</span><span class="p">,</span> <span class="p">[</span><span class="n">seastate</span><span class="p">.</span><span class="n">mu</span><span class="p">])</span> <span class="o">/</span> <span class="n">sum</span><span class="p">([</span><span class="n">seastate</span><span class="p">.</span><span class="n">mu</span><span class="p">]);</span>
<span class="n">end</span>

<span class="s">%</span> <span class="s">Copyright</span> <span class="s">2020</span> <span class="s">National</span> <span class="s">Technology</span> <span class="o">&amp;</span> <span class="n">Engineering</span> <span class="n">Solutions</span> <span class="n">of</span> <span class="n">Sandia</span><span class="p">,</span> 
<span class="c">% LLC (NTESS). Under the terms of Contract DE-NA0003525 with NTESS, the </span>
<span class="c">% U.S. Government retains certain rights in this software.</span>
<span class="c">%</span>
<span class="c">% This file is part of WecOptTool.</span>
<span class="c">% </span>
<span class="c">%     WecOptTool is free software: you can redistribute it and/or modify</span>
<span class="c">%     it under the terms of the GNU General Public License as published by</span>
<span class="c">%     the Free Software Foundation, either version 3 of the License, or</span>
<span class="c">%     (at your option) any later version.</span>
<span class="c">% </span>
<span class="c">%     WecOptTool is distributed in the hope that it will be useful,</span>
<span class="c">%     but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c">%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c">%     GNU General Public License for more details.</span>
<span class="c">% </span>
<span class="c">%     You should have received a copy of the GNU General Public License</span>
<span class="c">%     along with WecOptTool.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
</pre></div>
</td></tr></table></div>
</details></br><p>The general concept of WecOptTool is illustrated in the diagram below organized
into three columns.</p>
<blockquote>
<div><ul class="simple">
<li><strong>User Inputs</strong> (Green) - aspects of the tool that the user can interact with</li>
<li><strong>Data Classes</strong> (Blue) - objects used to store and transfer information within a study</li>
<li><strong>Solvers</strong> (Yellow) - physics models and optimization algorithms that process data</li>
</ul>
</div></blockquote>
<p>To run WecOptTool the user will need to define each of the six input blocks in
the User Inputs column. For the RM3, the Geometry will be defined by a mesh and
design variables (<span class="math notranslate nohighlight">\(r_1, r_2, d_1, d_2\)</span>), which refer to the spar/float
radius and distance between the surface water level and the distance between
the two bodies. In the Power Take Off (PTO) input, the user will define
constraints on the PTO such as max force, <span class="math notranslate nohighlight">\(F_{max}\)</span>, and max stroke
<span class="math notranslate nohighlight">\(\Delta x_{max}\)</span> and an operational constraint, <span class="math notranslate nohighlight">\(H_{s,max}\)</span>.).
Lastly, the kinematics will define how the two bodies of the RM3 move relative
to the resource and relative degrees of freedom.</p>
<p>Next, the user will choose one of three controllers to compute the resulting
dynamics(<code class="docutils literal notranslate"><span class="pre">ProportionalDamping</span></code>, <code class="docutils literal notranslate"><span class="pre">ComplexConjugate</span></code>, <code class="docutils literal notranslate"><span class="pre">PseudoSpectral</span></code>).
The Sea States input block for the RM3 may made up of a single spectrum or
multiple spectra. Finally, the user will need to determine some objective
function of interest for the device being studied.</p>
<p>WecOptTool will use the User Inputs to build a set of Data Classes and pass the
information to the Solvers. The Hydrodynamics Solver currently uses <a class="reference external" href="https://github.com/LHEEA/Nemoh">Nemoh</a> to
compute the linear wave-body interaction properties using the boundary element
method (BEM). The Optimal Control Solver will take the Data Classes to return
device results for the given controller and sea state. This output, paired with
some cost proxy from the device, can be used to evaluate the objective function
inside the Optimization Routine.</p>
<img alt="Conceptual illustration of WecOptTool functionality" src="../_images/WecOptToolFlowChart.svg" /><p>In WecOptTool, this process is executed by applying the following steps:</p>
<ol class="arabic simple">
<li>Select a device design and calculate its hydrodynamic parameters</li>
<li>Examine the performance of the device design using the chosen control
options, for a given sea state</li>
</ol>
<p>The remainder of this page will illustrate (using the <a class="reference external" href="https://github.com/SNL-WaterPower/WecOptTool/blob/master/examples/RM3/optimization.m"><code class="docutils literal notranslate"><span class="pre">optimization.m</span></code></a>
example) how this process is applied to a co-optimization problem.</p>
</div>
<div class="section" id="define-a-sea-state">
<span id="seastate"></span><h2>2.2. Define a sea state<a class="headerlink" href="#define-a-sea-state" title="Permalink to this headline">¶</a></h2>
<p>WecOptTool can simulate single or multiple spectra sea states, where weightings
can be provided to indicate the relative likelihood of each spectra. The
following lines from <a class="reference external" href="https://github.com/SNL-WaterPower/WecOptTool/blob/master/examples/RM3/optimization.m"><code class="docutils literal notranslate"><span class="pre">optimization.m</span></code></a> provide means of using the <a class="reference external" href="http://www.maths.lth.se/matstat/wafo/">WAFO</a> MATLAB
toolbox or a predefined spectra from WecOptTool.</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">% Create Bretschnider spectrum from WAFO and trim  off frequencies that </span>
<span class="c">% have less that 1% of the max spectral density</span>
<span class="c">% S = bretschneider([],[8,10],0);</span>
<span class="c">% SS = WecOptTool.SeaState(S, &quot;trimFrequencies&quot;, 0.01)</span>

<span class="c">% Load an example with multiple sea-states (8 differing spectra) and trim </span>
<span class="c">% off frequencies that have less that 1% of the max spectral density</span>
<span class="n">SS</span> <span class="p">=</span> <span class="n">WecOptTool</span><span class="p">.</span><span class="n">SeaState</span><span class="p">.</span><span class="n">example8Spectra</span><span class="p">(</span><span class="s">&quot;trimFrequencies&quot;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>Spectra are formatted following the convention of the <a class="reference external" href="http://www.maths.lth.se/matstat/wafo/">WAFO</a> MATLAB toolbox, but
can be generated via any means (e.g., from buoy measurements) as long as the
structure includes the <code class="docutils literal notranslate"><span class="pre">S.S</span></code> and <code class="docutils literal notranslate"><span class="pre">S.w</span></code> fields.</p>
<div class="code matlab highlight-default notranslate"><div class="highlight"><pre><span></span>S =

  struct with fields:

       S: [257×1 double]
       w: [257×1 double]
      tr: []
       h: Inf
    type: &#39;freq&#39;
     phi: 0
    norm: 0
    note: &#39;Bretschneider, Hm0 = 4, Tp = 5&#39;
    date: &#39;25-Mar-2020 13:08:28&#39;
</pre></div>
</div>
<p>In the active code above from <a class="reference external" href="https://github.com/SNL-WaterPower/WecOptTool/blob/master/examples/RM3/optimization.m"><code class="docutils literal notranslate"><span class="pre">optimization.m</span></code></a>, there are eight spectra loaded into a <a class="reference external" href="https://www.mathworks.com/help/matlab/matlab_prog/create-a-structure-array.html">struct array</a>.
These can be plotted using standard MATLAB commands.</p>
<div class="code matlab highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">figure</span>
<span class="n">hold</span> <span class="n">on</span>
<span class="n">grid</span> <span class="n">on</span>
<span class="n">arrayfun</span><span class="p">(</span><span class="o">@</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">w</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">S</span><span class="p">,</span><span class="s1">&#39;DisplayName&#39;</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">note</span><span class="p">),</span> <span class="n">S</span><span class="p">)</span>
<span class="n">legend</span><span class="p">()</span>
<span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Freq. [rad/s]&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Spect. density [m^2 rad/s]&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="Eight spectra consider in example.m" src="../_images/example_spectra.svg" /><p>The predefined spectra are returned as <a class="reference internal" href="api.html#+WecOptTool.SeaState" title="+WecOptTool.SeaState"><code class="xref mat mat-class docutils literal notranslate"><span class="pre">SeaState</span></code></a>
objects. The <a class="reference internal" href="api.html#+WecOptTool.SeaState" title="+WecOptTool.SeaState"><code class="xref mat mat-class docutils literal notranslate"><span class="pre">SeaState</span></code></a> class allows the user to
manipulate the given spectra to the requirements of the experiment.
Automatically, the weighting parameter <code class="docutils literal notranslate"><span class="pre">mu</span></code> will be set to unity when
multiple sea states are given with <code class="docutils literal notranslate"><span class="pre">mu</span></code> undefined. In this example,
frequencies that have less than 1% of the maximum spectral density are also
removed, (using the <code class="docutils literal notranslate"><span class="pre">&quot;trimFrequencies&quot;</span></code> option) to increase the speed of
computation with minimal loss of accuracy. See the
<a class="reference internal" href="api.html#+WecOptTool.SeaState" title="+WecOptTool.SeaState"><code class="xref mat mat-class docutils literal notranslate"><span class="pre">SeaState</span></code></a> documentation for all available options.</p>
</div>
<div class="section" id="create-file-storage">
<h2>2.3. Create file storage<a class="headerlink" href="#create-file-storage" title="Permalink to this headline">¶</a></h2>
<p>A number of processes used by WecOptTool require temporary storage for
intermediate files. Additionally, as part of the optimization process, it can
be useful to store data in temporary files for recovery later (as MATLAB
optimizers do not keep intermediate values). WecOptTool provides the
<a class="reference internal" href="api.html#+WecOptTool.AutoFolder" title="+WecOptTool.AutoFolder"><code class="xref mat mat-class docutils literal notranslate"><span class="pre">AutoFolder</span></code></a> class for just this purpose, which
provides a temporary storage space. Also, the user does not need to worry about
deleting the files contained in the folder when finished, as these are removed
automatically when the <a class="reference internal" href="api.html#+WecOptTool.AutoFolder" title="+WecOptTool.AutoFolder"><code class="xref mat mat-class docutils literal notranslate"><span class="pre">AutoFolder</span></code></a> object is deleted.
The folder is created as follows:</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">%% Create a folder for storing intermediate files</span>
<span class="n">folder</span> <span class="p">=</span> <span class="n">WecOptTool</span><span class="p">.</span><span class="n">AutoFolder</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="create-an-objective-function">
<h2>2.4. Create an objective function<a class="headerlink" href="#create-an-objective-function" title="Permalink to this headline">¶</a></h2>
<p>Next, we create the objective function we wish to minimize. Note, functions
must be defined at the bottom of the script, although we will use them above. The
complete code is as follows:</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">%% Define objective function</span>
<span class="c">% This can take any form that complies with the requirements of the MATLAB</span>
<span class="c">% optimization functions</span>

<span class="k">function</span><span class="w"> </span>fval <span class="p">=</span><span class="w"> </span><span class="nf">myWaveBotObjFun</span><span class="p">(</span>x, seastate, folder<span class="p">)</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="n">w</span> <span class="p">=</span> <span class="n">seastate</span><span class="p">.</span><span class="n">getRegularFrequencies</span><span class="p">(</span><span class="mf">0.5</span><span class="p">);</span>
    <span class="n">geomParams</span> <span class="p">=</span> <span class="p">[</span><span class="n">folder</span><span class="p">.</span><span class="n">path</span> <span class="n">num2cell</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">w</span><span class="p">];</span>

    <span class="p">[</span><span class="n">deviceHydro</span><span class="p">,</span> <span class="n">meshes</span><span class="p">]</span> <span class="p">=</span> <span class="n">designDevice</span><span class="p">(</span><span class="s">&#39;parametric&#39;</span><span class="p">,</span> <span class="n">geomParams</span><span class="p">{:});</span>
    
    <span class="n">for</span> <span class="s">j</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">seastate</span><span class="p">)</span>
        <span class="n">performances</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span> <span class="p">=</span> <span class="n">simulateDevice</span><span class="p">(</span><span class="n">deviceHydro</span><span class="p">,</span>   <span class="k">...</span>
                                         <span class="n">seastate</span><span class="p">(</span><span class="nb">j</span><span class="p">),</span>   <span class="k">...</span>
                                         <span class="s">&#39;CC&#39;</span><span class="p">);</span>
    <span class="n">end</span>
    
    <span class="s">fval</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">weightedPower</span><span class="p">(</span><span class="n">seastate</span><span class="p">,</span> <span class="n">performances</span><span class="p">);</span>
    
    <span class="p">[</span><span class="n">performances</span><span class="p">(:).</span><span class="n">w</span><span class="p">]</span> <span class="p">=</span> <span class="n">seastate</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
    <span class="n">performances</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">x</span> <span class="p">=</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">performances</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">meshes</span> <span class="p">=</span> <span class="n">meshes</span><span class="p">;</span>
    
    <span class="n">folder</span><span class="p">.</span><span class="n">stashVar</span><span class="p">(</span><span class="n">performances</span><span class="p">);</span>

<span class="n">end</span>

<span class="s">function</span> <span class="s">out</span> <span class="p">=</span> <span class="n">weightedPower</span><span class="p">(</span><span class="n">seastate</span><span class="p">,</span> <span class="n">performances</span><span class="p">)</span>
    <span class="n">pow</span> <span class="p">=</span> <span class="n">sum</span><span class="p">([</span><span class="n">performances</span><span class="p">.</span><span class="n">powPerFreq</span><span class="p">]);</span>
    <span class="n">out</span> <span class="p">=</span> <span class="nb">dot</span><span class="p">(</span><span class="n">pow</span><span class="p">,</span> <span class="p">[</span><span class="n">seastate</span><span class="p">.</span><span class="n">mu</span><span class="p">])</span> <span class="o">/</span> <span class="n">sum</span><span class="p">([</span><span class="n">seastate</span><span class="p">.</span><span class="n">mu</span><span class="p">]);</span>
<span class="n">end</span>
</pre></div>
</td></tr></table></div>
<p>The following subsections will describe each stage of setting up the objective
function.</p>
<div class="section" id="define-the-inputs">
<h3>2.4.1. Define the inputs<a class="headerlink" href="#define-the-inputs" title="Permalink to this headline">¶</a></h3>
<p>The input definition of an objective function used in WecOptTool is typically
going to take the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">result</span> <span class="o">=</span> <span class="n">myObjFun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">seastate</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">x</span></code> is the solution to be tested, <code class="docutils literal notranslate"><span class="pre">seastate</span></code> is a
<a class="reference internal" href="api.html#+WecOptTool.SeaState" title="+WecOptTool.SeaState"><code class="xref mat mat-class docutils literal notranslate"><span class="pre">SeaState</span></code></a> object and <code class="docutils literal notranslate"><span class="pre">folder</span></code> is an
<a class="reference internal" href="api.html#+WecOptTool.AutoFolder" title="+WecOptTool.AutoFolder"><code class="xref mat mat-class docutils literal notranslate"><span class="pre">AutoFolder</span></code></a> object. Although in most cases only <code class="docutils literal notranslate"><span class="pre">x</span></code>
will vary, the other inputs will be required within the optimization function
and can’t be accessed through the global workspace.</p>
</div>
<div class="section" id="define-design-variables">
<h3>2.4.2. Define design variables<a class="headerlink" href="#define-design-variables" title="Permalink to this headline">¶</a></h3>
<p>As shown in the diagram below, for RM3 study considered in <a class="reference external" href="https://github.com/SNL-WaterPower/WecOptTool/blob/master/examples/RM3/optimization.m"><code class="docutils literal notranslate"><span class="pre">optimization.m</span></code></a> the design variables are the radius of the surface float, <code class="docutils literal notranslate"><span class="pre">r1</span></code>, the radius of
the heave plate, <code class="docutils literal notranslate"><span class="pre">r2</span></code>, the draft of the surface float, <code class="docutils literal notranslate"><span class="pre">d1</span></code>, and the depth of the heave plate, <code class="docutils literal notranslate"><span class="pre">d2</span></code>, such that <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">[r1,</span> <span class="pre">r2,</span> <span class="pre">d1,</span> <span class="pre">d2]</span></code>.
The optimization algorithm will attempt to find the values of <code class="docutils literal notranslate"><span class="pre">x</span></code> that minimize the objective function.</p>
<a class="reference internal image-reference" href="../_images/example_rm3Parametric.svg"><img alt="RM3 device parametric dimensions" src="../_images/example_rm3Parametric.svg" width="400pt" /></a>
<p>For the RM3 example, the hydrodynamic assessment of a device design is
calculated by the <code class="docutils literal notranslate"><span class="pre">designDevice</span></code> function. The <code class="docutils literal notranslate"><span class="pre">'parametric'</span></code> option to
<code class="docutils literal notranslate"><span class="pre">designDevice</span></code> requires 6 arguments, a folder to store intermediate files,
the geometry design variables, <code class="docutils literal notranslate"><span class="pre">r1,</span> <span class="pre">r2,</span> <span class="pre">d1,</span> <span class="pre">d2</span></code>, and a representative set of
angular frequencies to be calculated by NEMOH. The folder is provided by the
<code class="docutils literal notranslate"><span class="pre">path</span></code> attribute of the <a class="reference internal" href="api.html#+WecOptTool.AutoFolder" title="+WecOptTool.AutoFolder"><code class="xref mat mat-class docutils literal notranslate"><span class="pre">AutoFolder</span></code></a> object. The
design variables will be passed by the optimization routine, while the
frequencies can be extracted from the given <a class="reference internal" href="api.html#+WecOptTool.SeaState" title="+WecOptTool.SeaState"><code class="xref mat mat-class docutils literal notranslate"><span class="pre">SeaState</span></code></a>
object using its <a class="reference internal" href="api.html#+WecOptTool.SeaState.getRegularFrequencies" title="+WecOptTool.SeaState.getRegularFrequencies"><code class="xref mat mat-meth docutils literal notranslate"><span class="pre">getRegularFrequencies()</span></code></a>
method, which provides regularly spaced frequencies covering all spectra in the
object array. These inputs are combined and then added as arguments to the
<code class="docutils literal notranslate"><span class="pre">designDevice</span></code> function, after the design option name.</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>71
72
73
74</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">w</span> <span class="p">=</span> <span class="n">seastate</span><span class="p">.</span><span class="n">getRegularFrequencies</span><span class="p">(</span><span class="mf">0.5</span><span class="p">);</span>
    <span class="n">geomParams</span> <span class="p">=</span> <span class="p">[</span><span class="n">folder</span><span class="p">.</span><span class="n">path</span> <span class="n">num2cell</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">w</span><span class="p">];</span>

    <span class="p">[</span><span class="n">deviceHydro</span><span class="p">,</span> <span class="n">meshes</span><span class="p">]</span> <span class="p">=</span> <span class="n">designDevice</span><span class="p">(</span><span class="s">&#39;parametric&#39;</span><span class="p">,</span> <span class="n">geomParams</span><span class="p">{:});</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="calculate-controlled-device-performance">
<span id="controlledperformance"></span><h3>2.4.3. Calculate controlled device performance<a class="headerlink" href="#calculate-controlled-device-performance" title="Permalink to this headline">¶</a></h3>
<p>In the RM3 example, three types of controllers are defined:</p>
<blockquote>
<div><ul>
<li><p class="first"><strong>Proportional Damping</strong> (<code class="docutils literal notranslate"><span class="pre">'P'</span></code>): Resistive damping (i.e., a proportional feedback on velocity) (see, e.g., <a class="reference internal" href="references.html#falnes2002" id="id1">[Falnes2002]</a>). Here, the power take-off (PTO) force is set as</p>
<div class="math notranslate nohighlight">
\[F_u(\omega) = -B_{PTO}(\omega)u(\omega)\]</div>
<p>where <span class="math notranslate nohighlight">\(B_{PTO}\)</span> is a constant chosen to maximize absorbed power and <span class="math notranslate nohighlight">\(u(\omega)\)</span> is the velocity. <br /> <br /></p>
</li>
<li><p class="first"><strong>Complex Conjugate</strong> (<code class="docutils literal notranslate"><span class="pre">'CC'</span></code>): Optimal power absorption through impedance matching (see, e.g., <a class="reference internal" href="references.html#falnes2002" id="id2">[Falnes2002]</a>). The intrinsic impedance is given by</p>
<div class="math notranslate nohighlight">
\[Z_i(\omega) = B(\omega) + i \left( \omega{}(m + A(\omega)) - \frac{K_{HS}}{\omega}\right) ,\]</div>
<p>where <span class="math notranslate nohighlight">\(\omega\)</span> is the radial frequency, <span class="math notranslate nohighlight">\(B(\omega)\)</span> is the
radiation damping, <span class="math notranslate nohighlight">\(m\)</span> is the rigid body mass, <span class="math notranslate nohighlight">\(A(\omega)\)</span> is the
added mass, and <span class="math notranslate nohighlight">\(K_{HS}\)</span> is the hydrostatic stiffness. Optimal power
transfer occurs when the PTO force, <span class="math notranslate nohighlight">\(F_u\)</span> is set such
that</p>
<div class="math notranslate nohighlight">
\[F_u(\omega) = -Z_i^*(\omega)u(\omega) ,\]</div>
<p>where <span class="math notranslate nohighlight">\(u(\omega)\)</span> is the velocity. <br /> <br /></p>
</li>
<li><p class="first"><strong>Pseudo Spectral</strong> (<code class="docutils literal notranslate"><span class="pre">'PS'</span></code>): Constrained optimal power absorption
<a class="reference internal" href="references.html#bacelli2014a" id="id3">[Bacelli2014a]</a>. This is a numerical optimal control algorithm capable of dealing
with both constraints and nonlinear dynamics. This approach is based on
<a class="reference external" href="https://en.wikipedia.org/wiki/Pseudospectral_optimal_control">pseudo spectral optimal control</a>.</p>
</li>
</ul>
</div></blockquote>
<p>For the <a class="reference external" href="https://github.com/SNL-WaterPower/WecOptTool/blob/master/examples/RM3/optimization.m"><code class="docutils literal notranslate"><span class="pre">optimization.m</span></code></a> example we choose the Complex Conjugate option. The
performance of the controlled device design is evaluated for a given sea state
by the <code class="docutils literal notranslate"><span class="pre">simulateDevice</span></code> function, which takes, as input, the output of the
<code class="docutils literal notranslate"><span class="pre">designDevice</span></code> function, the sea state to evaluate and the controller
selection (with additional optional parameters, if used). Here, the
device is evaluated across the 8 different sea states in the example spectra,
as follows:</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>76
77
78
79
80</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">for</span> <span class="s">j</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">seastate</span><span class="p">)</span>
        <span class="n">performances</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span> <span class="p">=</span> <span class="n">simulateDevice</span><span class="p">(</span><span class="n">deviceHydro</span><span class="p">,</span>   <span class="k">...</span>
                                         <span class="n">seastate</span><span class="p">(</span><span class="nb">j</span><span class="p">),</span>   <span class="k">...</span>
                                         <span class="s">&#39;CC&#39;</span><span class="p">);</span>
    <span class="n">end</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="define-the-objective-function-value">
<h3>2.4.4. Define the objective function value<a class="headerlink" href="#define-the-objective-function-value" title="Permalink to this headline">¶</a></h3>
<p>The value of the objective function is provided by an axillary function (called
<code class="docutils literal notranslate"><span class="pre">weightedPower</span></code>) which calculates the maximum absorbed power, weighted across
all spectra in the given sea state:</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>92
93
94
95</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>out <span class="p">=</span><span class="w"> </span><span class="nf">weightedPower</span><span class="p">(</span>seastate, performances<span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">pow</span> <span class="p">=</span> <span class="n">sum</span><span class="p">([</span><span class="n">performances</span><span class="p">.</span><span class="n">powPerFreq</span><span class="p">]);</span>
    <span class="n">out</span> <span class="p">=</span> <span class="nb">dot</span><span class="p">(</span><span class="n">pow</span><span class="p">,</span> <span class="p">[</span><span class="n">seastate</span><span class="p">.</span><span class="n">mu</span><span class="p">])</span> <span class="o">/</span> <span class="n">sum</span><span class="p">([</span><span class="n">seastate</span><span class="p">.</span><span class="n">mu</span><span class="p">]);</span>
<span class="n">end</span>
</pre></div>
</td></tr></table></div>
<p>Then, to make a minimization problem, the negation of this value returned:</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>82</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">fval</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">weightedPower</span><span class="p">(</span><span class="n">seastate</span><span class="p">,</span> <span class="n">performances</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>Objective function:</strong> The chosen objective function in <a class="reference external" href="https://github.com/SNL-WaterPower/WecOptTool/blob/master/examples/RM3/optimization.m"><code class="docutils literal notranslate"><span class="pre">optimization.m</span></code></a>
can be altered to better approximate a more meaningful objective (e.g.,
levelized cost of energy).</p>
</div>
</div>
<div class="section" id="record-intermediate-values">
<h3>2.4.5. Record intermediate values<a class="headerlink" href="#record-intermediate-values" title="Permalink to this headline">¶</a></h3>
<p>MATLAB’s optimization routines only store the sample and cost function values
of the designs tested. WecOptTool provides a means to store intermediate
values, used in the objection function, using the
<a class="reference internal" href="api.html#+WecOptTool.AutoFolder.stashVar" title="+WecOptTool.AutoFolder.stashVar"><code class="xref mat mat-meth docutils literal notranslate"><span class="pre">stashVar()</span></code></a> method of the
<a class="reference internal" href="api.html#+WecOptTool.AutoFolder" title="+WecOptTool.AutoFolder"><code class="xref mat mat-class docutils literal notranslate"><span class="pre">AutoFolder</span></code></a> class. In this example we add the sea
state frequencies, sample value and device meshes to the <code class="docutils literal notranslate"><span class="pre">simulateDevice</span></code>
function output and then stash it for recovery later:</p>
<blockquote>
<div><div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>84
85
86
87
88</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="p">[</span><span class="n">performances</span><span class="p">(:).</span><span class="n">w</span><span class="p">]</span> <span class="p">=</span> <span class="n">seastate</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
    <span class="n">performances</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">x</span> <span class="p">=</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">performances</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">meshes</span> <span class="p">=</span> <span class="n">meshes</span><span class="p">;</span>
    
    <span class="n">folder</span><span class="p">.</span><span class="n">stashVar</span><span class="p">(</span><span class="n">performances</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div></blockquote>
</div>
</div>
<div class="section" id="set-optimization-solver">
<h2>2.5. Set optimization solver<a class="headerlink" href="#set-optimization-solver" title="Permalink to this headline">¶</a></h2>
<p>MATLAB’s <a class="reference external" href="https://uk.mathworks.com/help/optim/ug/fmincon.html">fmincon</a> optimization solver is used in <a class="reference external" href="https://github.com/SNL-WaterPower/WecOptTool/blob/master/examples/RM3/optimization.m"><code class="docutils literal notranslate"><span class="pre">optimization.m</span></code></a>.</p>
<p>The initial values, <code class="docutils literal notranslate"><span class="pre">x0</span></code>, lower bounds, <code class="docutils literal notranslate"><span class="pre">lb</span></code>, and upper bounds, <code class="docutils literal notranslate"><span class="pre">ub</span></code> of the design variables can be set as follows.</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">% Add geometry design variables (parametric)</span>
<span class="n">x0</span> <span class="p">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">1.125</span><span class="p">,</span> <span class="mi">42</span><span class="p">];</span>
<span class="n">lb</span> <span class="p">=</span> <span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mi">41</span><span class="p">];</span>
<span class="n">ub</span> <span class="p">=</span> <span class="p">[</span><span class="mf">5.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">,</span> <span class="mi">43</span><span class="p">];</span>
</pre></div>
</td></tr></table></div>
<p>Options can also be supplied for fmincon:</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">% Define optimisation options</span>
<span class="n">opts</span> <span class="p">=</span> <span class="n">optimoptions</span><span class="p">(</span><span class="s">&#39;fmincon&#39;</span><span class="p">);</span>
<span class="n">opts</span><span class="p">.</span><span class="n">FiniteDifferenceType</span> <span class="p">=</span> <span class="s">&#39;central&#39;</span><span class="p">;</span>
<span class="n">opts</span><span class="p">.</span><span class="n">UseParallel</span> <span class="p">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">opts</span><span class="p">.</span><span class="n">MaxFunctionEvaluations</span> <span class="p">=</span> <span class="mi">5</span><span class="p">;</span> <span class="c">% set artificial low for fast running</span>
<span class="n">opts</span><span class="p">.</span><span class="n">Display</span> <span class="p">=</span> <span class="s">&#39;iter&#39;</span><span class="p">;</span>

<span class="c">% Enable dynamic plotting</span>
<span class="c">% opts.PlotFcn = {@optimplotx,@optimplotfval};</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">MaxFunctionEvaluations</span></code> is set to 5 in <a class="reference external" href="https://github.com/SNL-WaterPower/WecOptTool/blob/master/examples/RM3/optimization.m"><code class="docutils literal notranslate"><span class="pre">optimization.m</span></code></a> to permit relatively quick runs, but can be increased to allow for a potentially better solution (with the other options left as-is, this should require 150 function evaluations).</p>
</div>
<img alt="Progression of objective function value for RM3 example" src="../_images/example_optimplotfval.svg" /><p>In order to pass the above options, some dummy values must also be supplied for other arguments required by fmincon:</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">% Define unused parameters</span>
<span class="n">A</span> <span class="p">=</span> <span class="p">[];</span>
<span class="n">B</span> <span class="p">=</span> <span class="p">[];</span>
<span class="n">Aeq</span> <span class="p">=</span> <span class="p">[];</span>
<span class="n">Beq</span> <span class="p">=</span> <span class="p">[];</span>
<span class="n">NONLCON</span> <span class="p">=</span> <span class="p">[];</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="run-optimizer-and-view-results">
<h2>2.6. Run optimizer and view results<a class="headerlink" href="#run-optimizer-and-view-results" title="Permalink to this headline">¶</a></h2>
<p>Before using the objective function, the inputs must be simplified to allow
fmincon to just pass the design variables. To do this an <a class="reference external" href="https://uk.mathworks.com/help/matlab/matlab_prog/anonymous-functions.html">anonymous function</a>
is defined, which requires the design variables as input and fixes the value of
the SeaState and AutoFolder object inputs:</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>44
45</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">% Create simple objective function handle</span>
<span class="n">objFun</span> <span class="p">=</span> <span class="p">@(</span><span class="n">x</span><span class="p">)</span> <span class="n">myWaveBotObjFun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">SS</span><span class="p">,</span> <span class="n">folder</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>The study can then be executed by calling fmincon:</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>47
48</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">% Call the solver</span>
<span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">fval</span><span class="p">]</span> <span class="p">=</span> <span class="n">fmincon</span><span class="p">(</span><span class="n">objFun</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Aeq</span><span class="p">,</span> <span class="n">Beq</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">NONLCON</span><span class="p">,</span> <span class="n">opts</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>Once the calculation is complete, the <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">fval</span></code> variables show that the study has produced the following design:</p>
<ul class="simple">
<li><span class="math notranslate nohighlight">\(r_1\)</span>: 5 [m]</li>
<li><span class="math notranslate nohighlight">\(r_2\)</span>: 7.5 [m]</li>
<li><span class="math notranslate nohighlight">\(d_1\)</span>: 1.125 [m]</li>
<li><span class="math notranslate nohighlight">\(d_2\)</span>: 42 [m]</li>
<li>Maximum absorbed power: 2357934.25081 [W]</li>
</ul>
</div>
<div class="section" id="examine-optimum-design">
<h2>2.7. Examine optimum design<a class="headerlink" href="#examine-optimum-design" title="Permalink to this headline">¶</a></h2>
<p>To recover the detailed performance of all the device designs tested in the
optimization, the <a class="reference internal" href="api.html#+WecOptTool.AutoFolder.recoverVar" title="+WecOptTool.AutoFolder.recoverVar"><code class="xref mat mat-meth docutils literal notranslate"><span class="pre">recoverVar()</span></code></a> method of the
<a class="reference internal" href="api.html#+WecOptTool.AutoFolder" title="+WecOptTool.AutoFolder"><code class="xref mat mat-class docutils literal notranslate"><span class="pre">AutoFolder</span></code></a> class is used:</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">%% Recover device object of best simulation and plot its power per freq</span>
<span class="c">%% and mesh</span>
<span class="n">performances</span> <span class="p">=</span> <span class="n">folder</span><span class="p">.</span><span class="n">recoverVar</span><span class="p">(</span><span class="s">&quot;performances&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>Next, the device that matches the best solution returned by fmincon must be
found. To do this, compare the <code class="docutils literal notranslate"><span class="pre">x</span></code> field of the recovered structs, until a
match is found, as follows:</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>54
55
56
57
58
59
60</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="nb">i</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">performances</span><span class="p">)</span>
    <span class="n">test</span> <span class="p">=</span> <span class="n">performances</span><span class="p">{</span><span class="nb">i</span><span class="p">};</span>
    <span class="n">if</span> <span class="s">isequal(test(1).x,</span> <span class="s">x)</span>
        <span class="n">bestPerformances</span> <span class="p">=</span> <span class="n">test</span><span class="p">;</span>
        <span class="n">break</span>
    <span class="s">end</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></div>
<p>Finally, by using the <a class="reference internal" href="api.html#+WecOptTool.+plot.powerPerFreq" title="+WecOptTool.+plot.powerPerFreq"><code class="xref mat mat-func docutils literal notranslate"><span class="pre">WecOptTool.plot.powerPerFreq()</span></code></a> and
<a class="reference internal" href="api.html#+WecOptTool.+plot.plotMesh" title="+WecOptTool.+plot.plotMesh"><code class="xref mat mat-func docutils literal notranslate"><span class="pre">WecOptTool.plot.plotMesh()</span></code></a> functions, the spectral distribution of
energy absorbed by the resulting design for each of the eight sea states can be
shown, alongside the simulated meshes.</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>62
63</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">WecOptTool</span><span class="p">.</span><span class="n">plot</span><span class="p">.</span><span class="n">powerPerFreq</span><span class="p">(</span><span class="n">bestPerformances</span><span class="p">);</span>
<span class="n">WecOptTool</span><span class="p">.</span><span class="n">plot</span><span class="p">.</span><span class="n">plotMesh</span><span class="p">(</span><span class="n">bestPerformances</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">meshes</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<a class="reference internal image-reference" href="../_images/example_spectralPowerPlot.svg"><img alt="Absorbed Spectral power distribution for each sea state" src="../_images/example_spectralPowerPlot.svg" width="400pt" /></a>
<a class="reference internal image-reference" href="../_images/example_meshes.svg"><img alt="Absorbed Spectral power distribution for each sea state" src="../_images/example_meshes.svg" width="400pt" /></a>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="model.html" class="btn btn-neutral float-right" title="3. WEC Model Architecture" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="setup.html" class="btn btn-neutral float-left" title="1. Setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020 National Technology and Engineering Solutions of Sandia, LLC

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: v1.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../../v0.1.0/index.html">v0.1.0</a></dd>
            <dd><a href="optimization.html">v1.0.0</a></dd>
            <dd><a href="../../v1.0.1/user/optimization.html">v1.0.1</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../master/user/optimization.html">master</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>